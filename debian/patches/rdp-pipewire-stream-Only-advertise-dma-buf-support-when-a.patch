From: Pascal Nowack <Pascal.Nowack@gmx.de>
Date: Tue, 12 Apr 2022 08:51:28 +0200
Subject: rdp-pipewire-stream: Only advertise dma-buf support when available

Use the previously implemented API in the EGL thread to determine,
whether dma-bufs can be used or not.

https://gitlab.gnome.org/GNOME/gnome-remote-desktop/-/issues/89
---
 src/grd-rdp-pipewire-stream.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/grd-rdp-pipewire-stream.c b/src/grd-rdp-pipewire-stream.c
index 6e07b4c..5f8cb24 100644
--- a/src/grd-rdp-pipewire-stream.c
+++ b/src/grd-rdp-pipewire-stream.c
@@ -444,7 +444,7 @@ on_stream_param_changed (void                 *user_data,
   pod_builder = SPA_POD_BUILDER_INIT (params_buffer, sizeof (params_buffer));
 
   allowed_buffer_types = 1 << SPA_DATA_MemFd;
-  if (egl_thread)
+  if (egl_thread && grd_egl_thread_supports_dma_bufs (egl_thread))
     allowed_buffer_types |= 1 << SPA_DATA_DmaBuf;
 
   params[0] = spa_pod_builder_add_object (
@@ -1118,7 +1118,7 @@ connect_to_stream (GrdRdpPipeWireStream        *stream,
                             refresh_rate);
 
   egl_thread = grd_context_get_egl_thread (context);
-  if (egl_thread)
+  if (egl_thread && grd_egl_thread_supports_dma_bufs (egl_thread))
     {
       uint32_t drm_format;
       int n_modifiers;
